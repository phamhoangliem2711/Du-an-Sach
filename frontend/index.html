
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <h1>Chiều thứ 2 ca 3</h1>
  <title>Bán sách</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 20px; }
    input, button { padding: 8px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f3f3f3; }
    .form-group { margin-bottom: 15px; }
    .success { color: green; background: #d4edda; padding: 10px; margin: 10px 0; }
    .error { color: crimson; background: #f8d7da; padding: 10px; margin: 10px 0; }
  </style>
</head>
<body>
 
<h1>Shop Sách </h1>
<p>Frontend: Netlify | Backend: InfinityFree | CI/CD: GitHub Actions</p>

<section>
  <h2>Thêm sách</h2>
  <form id="addForm">
    <div class="form-group">
      <label>Tiêu đề</label>
      <input type="text" name="title" placeholder="Nhập tiêu đề sách" required>
    </div>
    <div class="form-group">
      <label>Tác giả</label>
      <input type="text" name="author" placeholder="Nhập tên tác giả" required>
    </div>
    <div class="form-group">
      <label>Giá (VNĐ)</label>
      <input type="number" step="0.01" name="price" placeholder="0.00" required>
    </div>
    <div class="form-group">
      <label>Số lượng</label>
      <input type="number" name="stock" placeholder="0" required>
    </div>
    <button type="submit" style="background: #007bff; color: white;">Thêm sách</button>
  </form>
  <div id="addMessage"></div>
</section>

<section>
  <h2>Danh sách sách</h2>
  <div id="error" class="error"></div>
  <div id="listContainer">Đang tải...</div>
</section>

<script>
// ========== CONFIG ==========
// SỬA ĐÂY: Dùng API endpoint đúng
const API_URL = "https://if0_40677219.infinityfreeapp.com/backend/api.php";

// ========== FUNCTIONS ==========
async function fetchBooks() {
    document.getElementById('error').textContent = '';
    document.getElementById('listContainer').textContent = 'Đang tải...';
    
    try {
        const response = await fetch(API_URL + '?action=list');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const books = await response.json();
        renderBooks(books);
    } catch (err) {
        document.getElementById('error').textContent = 'Lỗi khi tải dữ liệu: ' + err.message;
        document.getElementById('listContainer').textContent = 'Không thể tải danh sách.';
        console.error('Fetch error:', err);
    }
}

function renderBooks(books) {
    const container = document.getElementById('listContainer');
    
    if (!books || books.length === 0) {
        container.innerHTML = '<p>Chưa có sách nào. Hãy thêm sách mới!</p>';
        return;
    }
    
    let html = '<table><thead><tr><th>ID</th><th>Tiêu đề</th><th>Tác giả</th><th>Giá (VNĐ)</th><th>Số lượng</th></tr></thead><tbody>';
    
    books.forEach(book => {
        html += `
            <tr>
                <td>${book.id || ''}</td>
                <td>${escapeHtml(book.title)}</td>
                <td>${escapeHtml(book.author)}</td>
                <td>${formatCurrency(book.price)}</td>
                <td>${book.stock || book.quantity || 0}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function addBook(bookData) {
    const messageDiv = document.getElementById('addMessage');
    messageDiv.textContent = '';
    messageDiv.className = '';
    
    try {
        const response = await fetch(API_URL + '?action=add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(bookData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.textContent = '✅ ' + (result.message || 'Thêm sách thành công!');
            messageDiv.className = 'success';
            return true;
        } else {
            messageDiv.textContent = '❌ ' + (result.message || 'Lỗi khi thêm sách');
            messageDiv.className = 'error';
            return false;
        }
    } catch (err) {
        messageDiv.textContent = '❌ Lỗi kết nối: ' + err.message;
        messageDiv.className = 'error';
        return false;
    }
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        minimumFractionDigits: 0
    }).format(amount);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ========== EVENT LISTENERS ==========
document.getElementById('addForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    
    const bookData = {
        title: formData.get('title'),
        author: formData.get('author'),
        price: parseFloat(formData.get('price')),
        quantity: parseInt(formData.get('stock'))
    };
    
    const success = await addBook(bookData);
    
    if (success) {
        form.reset();
        await fetchBooks(); // Reload danh sách
    }
});

// ========== INITIAL LOAD ==========
fetchBooks();

// Test API connection on load
console.log('Frontend loaded. API URL:', API_URL);
</script>

<p style="margin-top: 30px; color: #666; font-size: 14px;">
    <strong>CI/CD Status:</strong> 
    <span id="ciStatus" style="color: green;">✅ Frontend deployed to Netlify</span>
</p>

</body>
</html>
'@ | Out-File frontend/index.html -Encoding UTF8

Write-Host "✅ Đã tạo file index.html mới với encoding đúng" -ForegroundColor Green